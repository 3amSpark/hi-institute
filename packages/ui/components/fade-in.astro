---
// src/components/FadeIn.astro
type Direction =
  | "bottom"
  | "top"
  | "left"
  | "right"
  | "top-left"
  | "top-right"
  | "bottom-left"
  | "bottom-right";

interface Props {
  duration?: number;
  delay?: number;
  from?: Direction;
  offset?: number;
  class?: string;
  /** @deprecated Use `from` and `offset` instead */
  yOffset?: number;
}

const {
  duration = 0.5,
  delay = 0,
  from = "bottom",
  offset = 35,
  yOffset,
  class: className,
} = Astro.props;

// Support legacy yOffset prop
const finalOffset = yOffset !== undefined ? yOffset : offset;
const finalFrom = yOffset !== undefined ? "top" : from;
---

<fade-in
  data-duration={duration}
  data-delay={delay}
  data-from={finalFrom}
  data-offset={finalOffset}
  class={className}
>
  <slot />
</fade-in>

<script>
  // Import GSAP and ScrollTrigger
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  // Register the plugin
  gsap.registerPlugin(ScrollTrigger);

  type Direction =
    | "bottom"
    | "top"
    | "left"
    | "right"
    | "top-left"
    | "top-right"
    | "bottom-left"
    | "bottom-right";

  function getOffsets(
    from: Direction,
    offset: number
  ): { x: number; y: number } {
    const diagonal = offset * 0.707; // cos(45Â°) for diagonal movement

    switch (from) {
      case "top":
        return { x: 0, y: -offset };
      case "bottom":
        return { x: 0, y: offset };
      case "left":
        return { x: -offset, y: 0 };
      case "right":
        return { x: offset, y: 0 };
      case "top-left":
        return { x: -diagonal, y: -diagonal };
      case "top-right":
        return { x: diagonal, y: -diagonal };
      case "bottom-left":
        return { x: -diagonal, y: diagonal };
      case "bottom-right":
        return { x: diagonal, y: diagonal };
      default:
        return { x: 0, y: offset };
    }
  }

  class FadeIn extends HTMLElement {
    connectedCallback() {
      // Read the data attributes we set in the HTML above
      const duration = parseFloat(this.dataset.duration || "0.5");
      const delay = parseFloat(this.dataset.delay || "0");
      const from = (this.dataset.from || "bottom") as Direction;
      const offset = parseFloat(this.dataset.offset || "20");

      const { x, y } = getOffsets(from, offset);

      // Different trigger points for mobile vs desktop
      const isMobile = window.matchMedia("(max-width: 767px)").matches;
      const triggerStart = isMobile ? "top 110%" : "top 85%";

      // Create the animation with GPU acceleration
      gsap.fromTo(
        this,
        {
          opacity: 0,
          x: x,
          y: y,
          scale: 0.85,
        },
        {
          delay: delay,
          duration: duration,
          opacity: 1,
          x: 0,
          y: 0,
          scale: 1,
          ease: "power2.out",
          force3D: true, // GPU accelerated transforms
          scrollTrigger: {
            trigger: this,
            start: triggerStart,
            toggleActions: "play none none reverse",
          },
        }
      );
    }
  }

  // Define the custom element
  // Browser checks if defined to prevent errors during hot module reloading
  if (!customElements.get("fade-in")) {
    customElements.define("fade-in", FadeIn);
  }
</script>
