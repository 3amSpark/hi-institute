---
import NavLink from "./nav-link.astro";
import MobileNavLink from "./mobile-nav-link.astro";

interface Route {
  href?: string;
  label: string;
  exact?: boolean;
  children?: { href: string; label: string }[];
}

interface Props {
  routes: Route[];
  logoSrc?: string;
  logoAlt?: string;
  mobileBreakpoint?: "lg" | "xl";
}

const {
  routes,
  logoSrc = "/logo.svg",
  logoAlt = "Logo",
  mobileBreakpoint = "xl",
} = Astro.props;

const dropdownLinkClass =
  "font-heading text-brand-gray/90 hover:bg-brand/10 hover:text-brand block rounded px-3 py-2 text-smaller font-medium uppercase transition-colors";

const breakpointClasses = {
  lg: {
    desktop: "lg:flex",
    mobile: "lg:hidden",
  },
  xl: {
    desktop: "xl:flex",
    mobile: "xl:hidden",
  },
};

const currentBreakpoint = breakpointClasses[mobileBreakpoint];
---

<!-- Mobile Menu Overlay -->
<div
  id="mobile-menu-overlay"
  class:list={[
    "pointer-events-none fixed inset-0 top-20 z-40 bg-black/0 transition-all duration-200",
    currentBreakpoint.mobile,
  ]}
>
</div>

<!-- Mobile Menu -->
<div
  id="mobile-menu"
  class:list={[
    "pointer-events-none fixed inset-x-0 top-20 z-40 h-[calc(100dvh-5rem)] -translate-y-2 overflow-y-auto bg-linear-to-t from-neutral-100 to-white opacity-0 transition-all duration-200",
    currentBreakpoint.mobile,
  ]}
>
  <div class="flex h-full flex-col">
    {
      routes.map((route) => (
        <div class="child-routes group" data-is-collapsed={true}>
          <MobileNavLink
            childCount={route.children?.length ?? 0}
            href={route.href}
          >
            {route.label}
          </MobileNavLink>
          <div class="route-children grid transition-all group-data-[is-collapsed=true]:grid-rows-[0fr] group-data-[is-collapsed=false]:grid-rows-[1fr]">
            <div class="overflow-hidden">
              <div class="transform transition-all duration-500 ease-[cubic-bezier(0.19,1,0.22,1)] group-data-[is-collapsed=true]:-translate-y-4 group-data-[is-collapsed=true]:opacity-0 group-data-[is-collapsed=false]:translate-y-0 group-data-[is-collapsed=false]:opacity-100">
                {route.children?.map((child) => (
                  <MobileNavLink href={child.href} isChild>
                    {child.label}
                  </MobileNavLink>
                ))}
              </div>
            </div>
          </div>
        </div>
      ))
    }
  </div>
</div>

<nav
  class="border-brand-gray/10 fixed top-0 right-0 left-0 z-50 border-b bg-white/90 backdrop-blur-sm"
>
  <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex h-20 items-center justify-between">
      <!-- Logo -->
      <a href="/" class="shrink-0">
        <img src={logoSrc} alt={logoAlt} class="h-8 w-auto" />
      </a>

      <!-- Desktop Navigation -->
      <div
        class:list={["hidden items-center gap-8", currentBreakpoint.desktop]}
      >
        {
          routes.map((route) =>
            route.children ? (
              <NavLink href={route.href}>
                {route.label}
                <Fragment slot="dropdown">
                  {route.children.map((child) => (
                    <a href={child.href} class={dropdownLinkClass}>
                      {child.label}
                    </a>
                  ))}
                </Fragment>
              </NavLink>
            ) : (
              <NavLink href={route.href} exact={route.exact}>
                {route.label}
              </NavLink>
            )
          )
        }
      </div>

      <!-- Mobile Menu Button -->
      <button
        id="open-mobile-menu"
        class:list={[
          "group relative flex size-10 cursor-pointer flex-col items-center justify-center gap-1.5",
          currentBreakpoint.mobile,
        ]}
        aria-label="Abrir menÃº"
      >
        <span
          class="bg-brand h-0.5 w-6 origin-center transition-all duration-300 group-[.menu-open]:translate-y-[8px] group-[.menu-open]:rotate-45"
        ></span>
        <span
          class="bg-brand h-0.5 w-6 transition-all duration-300 group-[.menu-open]:scale-0 group-[.menu-open]:opacity-0"
        ></span>
        <span
          class="bg-brand h-0.5 w-6 origin-center transition-all duration-300 group-[.menu-open]:-translate-y-[8px] group-[.menu-open]:-rotate-45"
        ></span>
      </button>
    </div>
  </div>
</nav>

<style>
  .route-children {
    transition:
      grid-template-rows 300ms cubic-bezier(0.19, 1, 0.22, 1),
      opacity 300ms cubic-bezier(0.19, 1, 0.22, 1);
  }
</style>

<script>
  const openBtn = document.getElementById("open-mobile-menu");
  const menu = document.getElementById("mobile-menu");
  const overlay = document.getElementById("mobile-menu-overlay");

  const mobileNavLinks = document.querySelectorAll(".collapse-button");
  mobileNavLinks.forEach((link) => {
    link.addEventListener("click", () => {
      // get the closest route-children container.
      const parentContainer = link.closest(".child-routes") as HTMLElement;
      if (!parentContainer) return;

      if (parentContainer.dataset.isCollapsed === "true") {
        parentContainer.dataset.isCollapsed = "false";
      } else {
        parentContainer.dataset.isCollapsed = "true";
      }
    });
  });

  function openMenu() {
    menu?.classList.remove(
      "opacity-0",
      "-translate-y-2",
      "pointer-events-none"
    );
    menu?.classList.add("opacity-100", "translate-y-0", "pointer-events-auto");
    overlay?.classList.remove("bg-black/0", "pointer-events-none");
    overlay?.classList.add("bg-black/30", "pointer-events-auto");
    openBtn?.classList.add("menu-open");
    document.body.classList.add("overflow-hidden");
  }

  function closeMenu() {
    menu?.classList.add("opacity-0", "-translate-y-2", "pointer-events-none");
    menu?.classList.remove(
      "opacity-100",
      "translate-y-0",
      "pointer-events-auto"
    );
    overlay?.classList.add("bg-black/0", "pointer-events-none");
    overlay?.classList.remove("bg-black/30", "pointer-events-auto");
    openBtn?.classList.remove("menu-open");
    document.body.classList.remove("overflow-hidden");
  }

  openBtn?.addEventListener("click", () => {
    const isOpen = menu?.classList.contains("opacity-100");
    if (isOpen) {
      closeMenu();
    } else {
      openMenu();
    }
  });

  overlay?.addEventListener("click", closeMenu);
</script>
